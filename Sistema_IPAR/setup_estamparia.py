import streamlit as st
import psycopg2

# Configura√ß√£o da P√°gina de Setup
st.set_page_config(page_title="Instalador Estamparia", page_icon="üèóÔ∏è")
st.title("üèóÔ∏è Criador de Tabelas - Estamparia (V2)")
st.warning("Este script cria as tabelas com o prefixo 'estamparia_' no Supabase.")

# Fun√ß√£o de Conex√£o (Padr√£o Blindado)
def init_connection():
    try:
        return psycopg2.connect(
            host=st.secrets["postgres"]["DB_HOST"],
            user=st.secrets["postgres"]["DB_USER"],
            password=st.secrets["postgres"]["DB_PASS"],
            dbname=st.secrets["postgres"]["DB_NAME"],
            port=st.secrets["postgres"]["DB_PORT"],
            sslmode='require'
        )
    except Exception as e:
        st.error(f"Erro de Conex√£o: {e}")
        return None

# SQL de Cria√ß√£o das Tabelas
SQL_SCRIPT = """
-- 1. Tabela de Apontamentos
CREATE TABLE IF NOT EXISTS estamparia_apontamentos (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    data TEXT, 
    cliente TEXT, 
    descricao_pc TEXT, 
    operacao TEXT, 
    materia_prima TEXT, 
    maquina TEXT, 
    tempo_ciclo_seg REAL, 
    operador TEXT, 
    setup_min INTEGER, 
    inicio_prod TEXT, 
    fim_prod TEXT, 
    qtd_produzida INTEGER, 
    refugo INTEGER,
    meta_pc_hora INTEGER DEFAULT 0, 
    custo_refugo_unit REAL DEFAULT 0, 
    ativo INTEGER DEFAULT 1
);

-- 2. Tabela de Paradas (Registro)
CREATE TABLE IF NOT EXISTS estamparia_paradas_reg (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    data TEXT, 
    maquina TEXT, 
    motivo TEXT, 
    inicio TEXT, 
    fim TEXT, 
    observacao TEXT, 
    ativo INTEGER DEFAULT 1
);

-- 3. Cadastros B√°sicos
CREATE TABLE IF NOT EXISTS estamparia_operadores (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    nome TEXT UNIQUE, 
    ativo INTEGER DEFAULT 1
);

CREATE TABLE IF NOT EXISTS estamparia_maquinas (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    nome TEXT UNIQUE, 
    horimetro_total REAL DEFAULT 0, 
    meta_manutencao REAL DEFAULT 500, 
    ativo INTEGER DEFAULT 1
);

CREATE TABLE IF NOT EXISTS estamparia_manutencoes (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    data_manut TEXT, 
    maquina TEXT, 
    tipo_manut TEXT, 
    descricao TEXT, 
    tecnico TEXT, 
    ativo INTEGER DEFAULT 1
);

CREATE TABLE IF NOT EXISTS estamparia_cad_operacoes (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    nome TEXT UNIQUE, 
    ativo INTEGER DEFAULT 1
);

CREATE TABLE IF NOT EXISTS estamparia_cad_materias (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    nome TEXT UNIQUE, 
    ativo INTEGER DEFAULT 1
);

CREATE TABLE IF NOT EXISTS estamparia_cad_paradas (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    nome TEXT UNIQUE, 
    ativo INTEGER DEFAULT 1
);

-- 4. Inserir Dados Iniciais (Seus padr√µes IPAR)
-- Opera√ß√µes
INSERT INTO estamparia_cad_operacoes (nome) VALUES 
('CORTE'), ('DOBRA'), ('REPUXO'), ('FURACAO'),
('AR (ARRUELA)'), ('ARRPX (ARRUELA RPX)'), ('DS (DISCO)'), 
('F (FUROS)'), ('ML (MIOLO)'), ('MM (MAMICA)')
ON CONFLICT (nome) DO NOTHING;

-- Mat√©rias
INSERT INTO estamparia_cad_materias (nome) VALUES 
('ACO CARBONO'), ('INOX'), ('ALUMINIO'),
('BC (BICO)'), ('CH (CHAPA)'), ('DS (DISC√ÉO)'), 
('DS SUPER (DISCO SUPER)'), ('DSQ (DISQUINHO)'), ('RT (RETALHO)'), ('SB (SOBRA)')
ON CONFLICT (nome) DO NOTHING;

-- Motivos de Parada
INSERT INTO estamparia_cad_paradas (nome) VALUES 
('Aus√™ncia Operador'), ('Inspe√ß√£o de Qualidade'), ('Limpeza / 5S'),
('P1 - AFIA√á√ÉO DE FERRAMENTA'), ('P2 - FALTA DE FERRAMENTA'), 
('P3 - SELECIONAR MAT√âRIA-PRIMA'), ('P4 - FALTA DE PRODU√á√ÉO'), 
('P5 - QUEBRA DE GARRA'), ('P6 - QUEBRA MEC√ÇNICA'), 
('P7 - PANE EL√âTRICA'), ('P8 - FALTA DE ENERGIA'), 
('P9 - OUTROS'), ('Setup / Troca de Estampo')
ON CONFLICT (nome) DO NOTHING;
"""

if st.button("üöÄ CRIAR TABELAS 'ESTAMPARIA_' AGORA"):
    conn = init_connection()
    if conn:
        cur = conn.cursor()
        try:
            # Executa o script inteiro
            cur.execute(SQL_SCRIPT)
            conn.commit()
            st.success("‚úÖ SUCESSO! Tabelas com prefixo 'estamparia_' criadas.")
            st.info("Dados padr√£o (AR, BC, P1...) inseridos.")
        except Exception as e:
            st.error(f"Erro ao criar tabelas: {e}")
        finally:
            cur.close()
            conn.close()